########
# Copyright (c) 2016 GigaSpaces Technologies Ltd. All rights reserved
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
############

name: clue
blueprint_path: cloudify-dev/blueprint.yaml
user_config_path: { env: [CLUE_CONFIG_PATH, ~/.clue] }

env_create:
  args:
    - name: [-d, --repos-dir]
      help: where to clone stuff to
      required: true
  inputs:
    repos_dir: { arg: repos_dir }
    branches_file: { concat: [{ user_config: storage_dir }, '/branches.yaml'] }

hooks:
  after_env_create: clue.hooks:after_env_create
  before_init: clue.hooks:before_init

templates:
  - &zero_retries_task
    retries: 0
    retry_interval: 0
  - &sequential_tasks
    <<: *zero_retries_task
    thread_pool_size: 1

command_after_init_on_apply: install

commands:
  install:
    workflow: install

  pip:
    install:
      workflow: execute_operation
      parameters:
        operation: pip.install
        run_by_dependency_order: true
        type_names: [python_package]
      event_cls: clue.output:NamedNodeEvent

  git:
    status:
      args:
        - name: [-a, --active]
          help: only display active branch set repos
          default: false
      task: *sequential_tasks
      workflow: execute_operation
      parameters:
        operation: git.status
        operation_kwargs:
          active: { arg: active }
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

    diff:
      args:
        - name: revision_range
          help: range to pass to git diff
      task: *sequential_tasks
      workflow: execute_operation
      parameters:
        operation: git.diff
        type_names: [git_repo]
        allow_kwargs_override: true
        operation_kwargs:
          revision_range: { arg: revision_range }
      event_cls: clue.output:NamedNodeEvent

    pull:
      workflow: execute_operation
      parameters:
        operation: git.pull
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

    squash:
      task: *zero_retries_task
      workflow: execute_operation
      parameters:
        operation: git.squash
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

    reset:
      args:
        - name: --origin
          help: reset from this base
          default: origin
        - name: --hard
          default: false
      task: *zero_retries_task
      workflow: execute_operation
      parameters:
        operation: git.reset
        operation_kwargs:
          origin: { arg: origin }
          hard: { arg: hard }
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

    rebase:
      task: *zero_retries_task
      workflow: execute_operation
      parameters:
        operation: git.rebase
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

    checkout:
      args:
        - name: branch
          help: branch name to checkout
          completer: clue.completion:branches_completer
      task: *zero_retries_task
      workflow: execute_operation
      parameters:
        allow_kwargs_override: true
        operation: git.checkout
        operation_kwargs:
          branch: { arg: branch }
        type_names: [git_repo]
      event_cls: clue.output:NamedNodeEvent

  nose:
    args:
      - name: package
        help: name of python package to run nosetests on
        completer: clue.completion:package_completer
    task: *sequential_tasks
    workflow: execute_operation
    parameters:
      operation: nose.run
      node_ids: [{ arg: package }]
    event_cls: clue.output:NoseEvent

task:
  retries: 5
  retry_interval: 1
  thread_pool_size: 20
